<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Фінансовий Менеджер - FinManager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #FDFBF7; color: #4A4A4A; }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 100%;
            height: 350px;
            max-height: 400px;
            margin: 0 auto;
        }
        @media (max-width: 768px) {
            .chart-container {
                height: 250px;
            }
        }
        .nav-item.active {
            @apply bg-stone-100 text-amber-600;
        }
        .card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .modal-open {
            overflow: hidden;
        }
        .form-input {
            @apply w-full p-3 border border-stone-300 rounded-lg focus:ring-amber-500 focus:border-amber-500 transition duration-150;
        }
        .form-label {
            @apply block text-sm font-medium text-stone-700 mb-1;
        }
        .assistant-message {
            background-color: #f3f4f6;
            border-radius: 12px 12px 12px 2px;
            padding: 1rem;
            max-width: 85%;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .user-message {
            background-color: #ffecc6; /* Light Amber */
            border-radius: 12px 12px 2px 12px;
            padding: 1rem;
            max-width: 85%;
            margin-bottom: 1rem;
            margin-left: auto;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="addTransactionModal" class="fixed inset-0 bg-stone-900 bg-opacity-75 z-50 hidden items-center justify-center p-4" onclick="if(event.target.id === 'addTransactionModal') closeModal()">
        <div class="card w-full max-w-lg p-6">
            <h2 class="text-2xl font-bold text-stone-800 mb-6 border-b pb-3">Додати Нову Операцію</h2>
            <form id="addTransactionForm">
                <div class="mb-4">
                    <label for="transactionType" class="form-label">Тип</label>
                    <select id="transactionType" required class="form-input">
                        <option value="expense">Витрата (-)</option>
                        <option value="income">Дохід (+)</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="transactionAmount" class="form-label">Сума (₴)</label>
                    <input type="number" id="transactionAmount" required min="0.01" step="0.01" class="form-input" placeholder="Наприклад, 1500.50">
                </div>
                <div class="mb-4">
                    <label for="transactionCategory" class="form-label">Категорія</label>
                    <select id="transactionCategory" required class="form-input"></select>
                </div>
                <div class="mb-4">
                    <label for="transactionDate" class="form-label">Дата</label>
                    <input type="date" id="transactionDate" required class="form-input" value="">
                </div>
                
                <div class="mb-4">
                    <label for="repeatFrequency" class="form-label">Повторювати</label>
                    <select id="repeatFrequency" class="form-input">
                        <option value="none">Не повторювати</option>
                        <option value="Monthly">Щомісячно (Напр., оренда)</option>
                        <option value="Yearly">Щорічно (Напр., страховка)</option>
                    </select>
                </div>
                
                <div class="mb-6">
                    <label for="transactionDescription" class="form-label">Опис (Необов'язково)</label>
                    <input type="text" id="transactionDescription" class="form-input" placeholder="Наприклад, Обід у кав'ярні">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeModal()" class="px-5 py-2 text-stone-600 bg-stone-200 rounded-lg hover:bg-stone-300 transition-colors">Скасувати</button>
                    <button type="submit" class="px-5 py-2 text-white bg-amber-600 rounded-lg hover:bg-amber-700 transition-colors"><i class="fa-solid fa-plus mr-2"></i> Додати</button>
                </div>
            </form>
        </div>
    </div>

    <div class="flex min-h-screen">
        <aside class="w-64 bg-white border-r border-stone-200 p-6 flex flex-col fixed h-full z-10">
            <h1 class="text-3xl font-bold text-stone-800 mb-10">FinManager</h1>
            <nav class="flex-grow">
                <a href="#" class="nav-item flex items-center p-3 rounded-xl transition-colors mb-2 active" data-view="dashboard">
                    <i class="fa-solid fa-chart-line w-5"></i>
                    <span class="ml-3 font-medium">Дашборд</span>
                </a>
                <a href="#" class="nav-item flex items-center p-3 rounded-xl transition-colors mb-2" data-view="transactions">
                    <i class="fa-solid fa-list-ul w-5"></i>
                    <span class="ml-3 font-medium">Операції</span>
                </a>
                <a href="#" class="nav-item flex items-center p-3 rounded-xl transition-colors mb-2" data-view="budgeting">
                    <i class="fa-solid fa-scale-balanced w-5"></i>
                    <span class="ml-3 font-medium">Бюджети</span>
                </a>
                <a href="#" class="nav-item flex items-center p-3 rounded-xl transition-colors mb-2" data-view="ai-assistant">
                    <i class="fa-solid fa-robot w-5"></i>
                    <span class="ml-3 font-medium">AI Помічник</span>
                </a>
            </nav>
            <div class="mt-auto">
                <button onclick="openModal()" class="w-full py-3 text-white bg-amber-600 rounded-xl hover:bg-amber-700 transition-colors shadow-lg shadow-amber-500/50">
                    <i class="fa-solid fa-plus-circle mr-2"></i> Нова Операція
                </button>
                <div class="mt-4 text-center text-sm text-stone-500" id="auth-status">
                    Статус: <span class="text-red-500">Очікування авторизації</span>
                </div>
                <div class="mt-2 text-center text-xs text-stone-400" id="data-source-info">
                    Використовується Mock Data
                </div>
            </div>
        </aside>

        <main class="flex-grow p-8 md:p-10 ml-64">
            <header class="mb-8 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
                <h2 class="text-3xl font-bold text-stone-800" id="view-title">Дашборд</h2>
                <div class="flex items-center space-x-4 w-full md:w-auto">
                    <div class="relative w-full md:w-64">
                        <input type="text" id="searchFilter" placeholder="Пошук за описом..." class="form-input pr-10 bg-white">
                        <i class="fa-solid fa-magnifying-glass absolute right-3 top-1/2 transform -translate-y-1/2 text-stone-400"></i>
                    </div>
                </div>
            </header>

            <div id="dashboard-view" class="view">
                <div id="kpi-cards" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    </div>

                <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                    <div class="lg:col-span-3 space-y-6">
                        <div class="card p-6">
                            <h3 class="text-xl font-semibold mb-6 text-stone-800">Аналіз Доходів та Витрат (за днями)</h3>
                            <div class="chart-container">
                                <canvas id="barChart"></canvas>
                            </div>
                        </div>

                        <div class="card p-6">
                            <h3 class="text-xl font-semibold mb-6 text-stone-800">Витрати за Останніх 6 Місяців</h3>
                            <div class="chart-container">
                                <canvas id="lineChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-2 card p-6">
                         <h3 class="text-xl font-semibold mb-4 text-stone-800">Прогрес Бюджетування (Місяць)</h3>
                         <div id="budgeting-setup-link" class="mb-4">
                            <button onclick="switchView('budgeting')" class="text-sm text-blue-600 hover:text-blue-800 transition-colors">
                                <i class="fa-solid fa-scale-balanced mr-1"></i> Налаштувати Бюджети
                            </button>
                        </div>
                        <div id="budgetingAnalysisContentDashboard">
                            </div>
                    </div>
                </div>
            </div>

            <div id="transactions-view" class="view hidden">
                <div class="card p-6 mb-8">
                    <h3 class="text-xl font-semibold mb-4 text-stone-800">Фільтри</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <label for="typeFilter" class="form-label">Тип</label>
                            <select id="typeFilter" class="form-input">
                                <option value="all">Всі</option>
                                <option value="income">Дохід</option>
                                <option value="expense">Витрата</option>
                            </select>
                        </div>
                        <div>
                            <label for="categoryFilter" class="form-label">Категорія</label>
                            <select id="categoryFilter" class="form-input">
                                <option value="all">Всі</option>
                                </select>
                        </div>
                        <div>
                            <label for="sortOrder" class="form-label">Сортування</label>
                            <select id="sortOrder" class="form-input" onchange="applyFilters()">
                                <option value="dateDesc">За датою (Новіші)</option>
                                <option value="dateAsc">За датою (Старіші)</option>
                                <option value="amountDesc">За сумою (Спадання)</option>
                                <option value="amountAsc">За сумою (Зростання)</option>
                            </select>
                        </div>
                        <div>
                            <label for="monthFilter" class="form-label">Місяць</label>
                            <input type="month" id="monthFilter" class="form-input" onchange="applyFilters()">
                        </div>
                    </div>
                </div>

                <div class="card p-6">
                    <h3 class="text-xl font-semibold mb-4 text-stone-800">Таблиця Операцій</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-stone-200">
                            <thead class="bg-stone-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">Дата</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">Тип</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">Категорія</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">Опис</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-stone-500 uppercase tracking-wider">Сума (₴)</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-stone-500 uppercase tracking-wider">Дії</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTableBody" class="bg-white divide-y divide-stone-200">
                                </tbody>
                        </table>
                    </div>
                    <div id="paginationControls" class="flex justify-between items-center mt-4">
                        <button onclick="changePage(-1)" class="px-3 py-1 bg-stone-200 rounded-lg hover:bg-stone-300 transition-colors" id="prevPageBtn">Попередня</button>
                        <span id="pageInfo" class="text-sm text-stone-600">Сторінка 1 з 1</span>
                        <button onclick="changePage(1)" class="px-3 py-1 bg-stone-200 rounded-lg hover:bg-stone-300 transition-colors" id="nextPageBtn">Наступна</button>
                    </div>
                </div>
            </div>
            
            <div id="budgeting-view" class="view hidden">
                <div class="card p-6 mb-8">
                    <h3 class="text-xl font-semibold mb-4 text-stone-800">Налаштування Місячних Бюджетів</h3>
                    <p class="text-stone-600 mb-6">Встановіть максимальні суми витрат для кожної категорії на поточний місяць. Залишіть поле пустим, щоб видалити бюджет.</p>
                    <form id="budgetForm" class="grid grid-cols-1 md:grid-cols-3 gap-6" onsubmit="saveBudgets(event)">
                        <div id="budgetFieldsContainer" class="md:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-6">
                            </div>
                        <div class="md:col-span-3 pt-4 border-t border-stone-200 flex justify-end">
                            <button type="submit" class="px-5 py-2 text-white bg-emerald-600 rounded-lg hover:bg-emerald-700 transition-colors">
                                <i class="fa-solid fa-save mr-2"></i> Зберегти Бюджети
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="card p-6">
                    <h3 class="text-xl font-semibold mb-4 text-stone-800">Поточне Використання Бюджету</h3>
                    <div id="budgetingAnalysisContentBudget">
                         </div>
                </div>
            </div>

            <div id="ai-assistant-view" class="view hidden">
                <div class="card p-6 mb-6">
                    <h3 class="text-xl font-semibold mb-4 text-stone-800">Персональний Фінансовий Помічник</h3>
                    <p class="text-stone-600 mb-6">Запитай помічника про свої фінанси, наприклад: "Як я можу скоротити витрати?" або "Яка моя найбільша категорія витрат?".</p>
                    
                    <div id="chatWindow" class="h-96 overflow-y-auto p-4 border rounded-lg bg-white mb-6 space-y-4">
                        <div class="assistant-message text-stone-700">
                            <p class="font-bold text-amber-600 mb-1"><i class="fa-solid fa-robot mr-2"></i> AI-Помічник:</p>
                            <p>Привіт! Я твій особистий фінансовий помічник. Я можу аналізувати твої доходи та витрати за поточний місяць, щоб дати тобі корисні поради. Чим я можу допомогти?</p>
                        </div>
                        </div>

                    <form id="assistantForm" class="flex gap-4">
                        <input type="text" id="assistantQuery" placeholder="Введіть ваше запитання..." required class="form-input flex-grow">
                        <button type="submit" id="sendAssistantQuery" class="px-5 py-2 text-white bg-amber-600 rounded-lg hover:bg-amber-700 transition-colors">
                            <i class="fa-solid fa-paper-plane mr-2"></i> Надіслати
                        </button>
                    </form>
                </div>
            </div>

        </main>
    </div>

    <script>
        // --- CONSTANTS ---
        const CATEGORIES = {
            'income': ['Зарплата', 'Інвестиції', 'Подарунки', 'Інше'],
            'expense': ['Оренда', 'Їжа', 'Транспорт', 'Комунальні', 'Дозвілля', 'Одяг', 'Здоров\'я', 'Інше']
        };

        // --- STATE & DATA ---
        let state = {
            user: null, 
            isMockMode: true, 
            transactions: [], 
            recurringTransactions: [], 
            budgets: {}, 
            currentPage: 1,
            transactionsPerPage: 10,
            filteredTransactions: [],
        };

        // Chart.js instances
        let barChartInstance = null;
        let lineChartInstance = null; // <-- NEW: Instance for 6-month expense line chart
        
        // Helper for currency formatting
        const formatter = new Intl.NumberFormat('uk-UA', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        
        // Helper to generate unique client-side IDs
        const generateUniqueId = () => Date.now().toString(36) + Math.random().toString(36).substring(2);

        // --- MOCK DATA (for isMockMode = true) ---
        function generateMockData() {
            const mockTransactions = [];
            const today = new Date();
            
            // Function to generate a random date in a specific month/year
            const getRandomDate = (month, year) => {
                const day = Math.floor(Math.random() * 28) + 1;
                return `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            };

            // Generate transactions for the last 6 months to populate the line chart
            for (let m = 0; m < 6; m++) {
                const monthDate = new Date(today.getFullYear(), today.getMonth() - m, 1);
                const month = monthDate.getMonth();
                const year = monthDate.getFullYear();
                
                const numTx = Math.floor(Math.random() * 15) + 25; // 25 to 40 transactions per month

                for (let i = 0; i < numTx; i++) {
                    const type = Math.random() < 0.3 ? 'income' : 'expense';
                    const categoryList = CATEGORIES[type];
                    const category = categoryList[Math.floor(Math.random() * categoryList.length)];
                    
                    // Slightly varied amounts
                    let amount;
                    if (type === 'income') {
                        amount = parseFloat((Math.random() * 10000 + 5000).toFixed(2));
                        // Ensure one large income/expense for the current month is generated
                        if (m === 0 && i === 0 && type === 'income') amount = 35000; 
                    } else {
                        amount = parseFloat((Math.random() * 5000 + 100).toFixed(2));
                    }
                    
                    mockTransactions.push({
                        id: generateUniqueId(),
                        type: type,
                        amount: amount,
                        category: category,
                        description: `${type === 'income' ? 'Отримання' : 'Сплата'} за ${category}`,
                        date: getRandomDate(month, year),
                        // timestamp is used for sorting in transaction list
                        timestamp: monthDate.getTime() + (i * 1000000) 
                    });
                }
            }
            
            // Mock Recurring Transactions
            const prevMonthDate = new Date();
            prevMonthDate.setMonth(prevMonthDate.getMonth() - 1);
            const prevMonth = prevMonthDate.getMonth();
            const prevYear = prevMonthDate.getFullYear();

            const mockRecurring = [
                 { id: 'rtx1', type: 'expense', amount: 8000.00, category: 'Оренда', description: 'Оренда квартири', repeat: 'Monthly', startDate: getRandomDate(prevMonth, prevYear) },
                 { id: 'rtx2', type: 'income', amount: 35000.00, category: 'Зарплата', description: 'Основна зарплата', repeat: 'Monthly', startDate: getRandomDate(prevMonth, prevYear) },
            ];

            // Mock Budgets
            const mockBudgets = {
                'Їжа': 7000,
                'Транспорт': 1500,
                'Дозвілля': 3000,
            };

            return { mockTransactions, mockRecurring, mockBudgets };
        }

        function initFirebase() {
            // NOTE: У реальному проєкті тут має бути код ініціалізації Firebase, 
            // завантаження конфігурації та підключення до Firestore.
            // Для цілей цього єдиного файлу, ми імітуємо завантаження даних.

            const authStatus = document.getElementById('auth-status');
            const sourceInfo = document.getElementById('data-source-info');
            
            // Імітація успішної авторизації
            state.user = { uid: 'mockUserId123' };
            authStatus.innerHTML = 'Статус: <span class="text-emerald-500">Авторизовано (Mock)</span>';
            sourceInfo.textContent = 'Використовується Mock Data';

            // Імітація завантаження даних
            const { mockTransactions, mockRecurring, mockBudgets } = generateMockData();
            state.transactions = mockTransactions;
            state.recurringTransactions = mockRecurring;
            state.budgets = mockBudgets;

            // Process recurring transactions on load
            processRecurringTransactions(); 
            
            // Після завантаження даних - оновлюємо UI
            renderUI();
        }

        // --- MODAL & UI CONTROL ---
        function openModal() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('transactionDate').value = today;
            document.getElementById('addTransactionModal').classList.remove('hidden');
            document.getElementById('addTransactionModal').classList.add('flex');
            document.body.classList.add('modal-open');
        }

        function closeModal() {
            document.getElementById('addTransactionModal').classList.add('hidden');
            document.getElementById('addTransactionModal').classList.remove('flex');
            document.body.classList.remove('modal-open');
            document.getElementById('addTransactionForm').reset();
        }

        function switchView(viewName) {
            document.querySelectorAll('.view').forEach(view => {
                view.classList.add('hidden');
            });
            document.getElementById(`${viewName}-view`).classList.remove('hidden');

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.nav-item[data-view="${viewName}"]`).classList.add('active');
            
            // Set title and trigger specific renders
            const titleMap = {
                'dashboard': 'Дашборд',
                'transactions': 'Операції',
                'budgeting': 'Бюджети',
                'ai-assistant': 'AI Фінансовий Помічник'
            };
            document.getElementById('view-title').textContent = titleMap[viewName];

            if (viewName === 'transactions') {
                applyFilters(); 
            } else if (viewName === 'dashboard') {
                renderDashboard();
            } else if (viewName === 'budgeting') {
                renderBudgets();
                renderBudgetingAnalysis('budgetingAnalysisContentBudget'); // Render on Budget view
            } else if (viewName === 'ai-assistant') {
                document.getElementById('assistantQuery').focus();
            }
        }

        function populateCategorySelects() {
            const categorySelect = document.getElementById('transactionCategory');
            const filterCategorySelect = document.getElementById('categoryFilter');

            // Clear existing options
            categorySelect.innerHTML = '';
            filterCategorySelect.innerHTML = '<option value="all">Всі</option>';

            const allCategories = [...new Set([...CATEGORIES.income, ...CATEGORIES.expense])].sort();

            allCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option.cloneNode(true));
                filterCategorySelect.appendChild(option);
            });
        }
        
        function renderUI() {
            populateCategorySelects();
            renderDashboard();
            applyFilters();
        }

        // --- TRANSACTION LOGIC ---
        
        // Logic for Recurring Transactions
        function processRecurringTransactions() {
            const today = new Date();
            
            const transactionsToAdd = []; 

            state.recurringTransactions.forEach(rtx => {
                const startDate = new Date(rtx.startDate);
                let nextDate = new Date(rtx.startDate); 

                while (nextDate.getTime() <= today.getTime()) {
                    
                    const isAlreadyAdded = state.transactions.some(t => {
                        const tDate = new Date(t.date);
                        return t.recurringId === rtx.id && 
                               tDate.getMonth() === nextDate.getMonth() && 
                               tDate.getFullYear() === nextDate.getFullYear();
                    });
                    
                    if (!isAlreadyAdded) {
                         const newTransaction = {
                            ...rtx,
                            id: generateUniqueId(), 
                            recurringId: rtx.id, 
                            date: nextDate.toISOString().split('T')[0], 
                            timestamp: nextDate.getTime()
                        };
                        delete newTransaction.repeat; 
                        delete newTransaction.startDate;
                        
                        transactionsToAdd.push(newTransaction);
                    }

                    if (rtx.repeat === 'Monthly') {
                        nextDate.setMonth(nextDate.getMonth() + 1);
                    } else if (rtx.repeat === 'Yearly') {
                        nextDate.setFullYear(nextDate.getFullYear() + 1);
                    } else {
                        break; 
                    }
                    
                    if (nextDate.getTime() > today.getTime() + (31 * 24 * 60 * 60 * 1000)) { 
                        break;
                    }
                }
            });
            
            state.transactions.push(...transactionsToAdd);
        }

        function submitNewTransaction(e) {
            e.preventDefault();
            
            const type = document.getElementById('transactionType').value;
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            const category = document.getElementById('transactionCategory').value;
            const date = document.getElementById('transactionDate').value;
            const description = document.getElementById('transactionDescription').value || '';
            
            const repeat = document.getElementById('repeatFrequency').value;

            if (repeat !== 'none') {
                const newRecurringTx = {
                    id: generateUniqueId(),
                    uid: state.user.uid,
                    timestamp: new Date(date).getTime(),
                    date: date, 
                    type: type,
                    amount: amount,
                    category: category,
                    description: description,
                    repeat: repeat, 
                    startDate: date 
                };
                
                state.recurringTransactions.push(newRecurringTx);
                
                processRecurringTransactions();
                
            } else {
                const newTransaction = {
                    id: generateUniqueId(),
                    uid: state.user.uid,
                    timestamp: new Date(date).getTime(),
                    date: date,
                    type: type,
                    amount: amount,
                    category: category,
                    description: description,
                };
                
                state.transactions.push(newTransaction);
            }

            closeModal();
            renderUI(); 
        }

        function deleteTransaction(transactionId) {
            if (confirm('Ви впевнені, що хочете видалити цю операцію?')) {
                const initialLength = state.transactions.length;
                state.transactions = state.transactions.filter(t => t.id !== transactionId);

                if (initialLength === state.transactions.length) {
                    state.recurringTransactions = state.recurringTransactions.filter(t => t.id !== transactionId);
                }
                
                renderUI(); 
            }
        }
        
        function applyFilters() {
            const type = document.getElementById('typeFilter').value;
            const category = document.getElementById('categoryFilter').value;
            const search = document.getElementById('searchFilter').value.toLowerCase();
            const sortOrder = document.getElementById('sortOrder').value;
            const monthValue = document.getElementById('monthFilter').value; 

            let filtered = state.transactions.slice(); 

            // 1. Month Filter
            if (monthValue) {
                filtered = filtered.filter(t => t.date.startsWith(monthValue));
            }

            // 2. Type Filter
            if (type !== 'all') {
                filtered = filtered.filter(t => t.type === type);
            }

            // 3. Category Filter
            if (category !== 'all') {
                filtered = filtered.filter(t => t.category === category);
            }
            
            // 4. Search Filter (by description)
            if (search) {
                filtered = filtered.filter(t => t.description.toLowerCase().includes(search));
            }

            // 5. Sorting
            filtered.sort((a, b) => {
                const aVal = a.amount;
                const bVal = b.amount;
                const aDate = new Date(a.date).getTime();
                const bDate = new Date(b.date).getTime();

                switch (sortOrder) {
                    case 'dateDesc': return bDate - aDate;
                    case 'dateAsc': return aDate - bDate;
                    case 'amountDesc': return bVal - aVal;
                    case 'amountAsc': return aVal - bVal;
                    default: return bDate - aDate;
                }
            });

            state.filteredTransactions = filtered;
            state.currentPage = 1; 
            renderTransactionsTable(filtered);
        }
        
        function renderTransactionsTable(transactions) {
            const tbody = document.getElementById('transactionsTableBody');
            tbody.innerHTML = '';
            
            const start = (state.currentPage - 1) * state.transactionsPerPage;
            const end = start + state.transactionsPerPage;
            const paginatedTransactions = transactions.slice(start, end);

            paginatedTransactions.forEach(t => {
                const isExpense = t.type === 'expense';
                const sign = isExpense ? '-' : '+';
                const color = isExpense ? 'text-rose-600' : 'text-emerald-600';
                
                const recurringIcon = t.recurringId ? `<i class="fa-solid fa-repeat text-blue-400 mr-1" title="Повторювана операція"></i>` : '';

                const row = `
                    <tr class="hover:bg-stone-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">${t.date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${color}">${t.type === 'income' ? 'Дохід' : 'Витрата'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-700">${t.category}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-700">${recurringIcon}${t.description || '—'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-right ${color}">${sign} ${formatter.format(t.amount)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="deleteTransaction('${t.id}')" class="text-rose-600 hover:text-rose-900 transition-colors">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            // Update Pagination
            const totalPages = Math.ceil(transactions.length / state.transactionsPerPage);
            document.getElementById('pageInfo').textContent = `Сторінка ${state.currentPage} з ${totalPages || 1}`;
            document.getElementById('prevPageBtn').disabled = state.currentPage <= 1;
            document.getElementById('nextPageBtn').disabled = state.currentPage >= totalPages;
        }

        function changePage(delta) {
            const totalPages = Math.ceil(state.filteredTransactions.length / state.transactionsPerPage);
            const newPage = state.currentPage + delta;
            
            if (newPage >= 1 && newPage <= totalPages) {
                state.currentPage = newPage;
                renderTransactionsTable(state.filteredTransactions);
            }
        }
        
        // --- DASHBOARD & ANALYSIS ---
        
        function renderDashboard() {
            renderKpiCards();
            updateCharts();
            renderBudgetingAnalysis('budgetingAnalysisContentDashboard'); // Render on Dashboard
        }

        // KPI Comparison with Previous Month
        function calculateKpi() {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            // 1. Фільтрація та агрегація для заданого місяця
            const getMonthlyKpi = (month, year) => {
                const transactions = state.transactions.filter(t => {
                    const date = new Date(t.date);
                    return date.getMonth() === month && date.getFullYear() === year;
                });

                const totalIncome = transactions
                    .filter(t => t.type === 'income')
                    .reduce((sum, t) => sum + t.amount, 0);

                const totalExpense = transactions
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);

                return { totalIncome, totalExpense, balance: totalIncome - totalExpense };
            };

            // 2. Визначення попереднього місяця
            const prevMonthDate = new Date();
            prevMonthDate.setMonth(prevMonthDate.getMonth() - 1);
            const prevMonth = prevMonthDate.getMonth();
            const prevYear = prevMonthDate.getFullYear();

            const current = getMonthlyKpi(currentMonth, currentYear);
            const previous = getMonthlyKpi(prevMonth, prevYear);

            // 3. Розрахунок відмінностей
            const calculateChange = (currentVal, previousVal) => {
                if (previousVal === 0) {
                    if (currentVal === 0) return 0;
                    return currentVal > 0 ? 100 : 0; 
                }
                return ((currentVal - previousVal) / previousVal) * 100;
            };

            return {
                // Поточні дані
                currentIncome: current.totalIncome,
                currentExpense: current.totalExpense,
                currentBalance: current.balance,
                // Порівняння з попереднім місяцем
                incomeChange: calculateChange(current.totalIncome, previous.totalIncome),
                expenseChange: calculateChange(current.totalExpense, previous.totalExpense),
                balanceChange: calculateChange(current.balance, previous.balance)
            };
        }
        
        // Render KPI Cards with Comparison
        function renderKpiCards() {
            const { 
                currentIncome, currentExpense, currentBalance,
                incomeChange, expenseChange, balanceChange 
            } = calculateKpi();

            const cardsContainer = document.getElementById('kpi-cards');

            const formatChange = (change, isExpense) => {
                const displayChange = isExpense ? -change : change;
                
                const isPositive = displayChange >= 0;
                const icon = isPositive ? 'fa-arrow-up' : 'fa-arrow-down';
                const color = isPositive ? 'text-emerald-600' : 'text-rose-600';
                
                const sign = isPositive ? '+' : '';

                if (Math.abs(change) === 100 && (currentIncome > 0 || currentExpense > 0)) {
                    return `<span class="text-blue-600 font-medium"><i class="fa-solid fa-star mr-1"></i> Нові дані</span>`;
                }
                
                if (change === 100 && currentBalance > 0 && currentIncome > 0 && currentExpense === 0) {
                     return `<span class="text-emerald-600 font-medium"><i class="fa-solid fa-star mr-1"></i> Значне зростання</span>`;
                }

                return `<span class="${color} font-medium">
                            <i class="fa-solid ${icon} mr-1"></i> 
                            ${sign}${Math.abs(displayChange).toFixed(1)}% 
                        </span>`;
            };

            cardsContainer.innerHTML = `
                <div class="card p-6 border-l-4 border-emerald-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-stone-500 text-sm font-medium">Доходи (місяць)</p>
                            <h3 class="text-2xl font-bold text-stone-800 mt-1">${formatter.format(currentIncome)} ₴</h3>
                        </div>
                        <div class="bg-emerald-100 p-2 rounded-lg text-emerald-600">
                            <i class="fa-solid fa-sack-dollar"></i>
                        </div>
                    </div>
                    <div class="mt-4 text-sm flex items-center gap-2">
                        ${formatChange(incomeChange, false)}
                        <span class="text-stone-500 text-xs"> порівняно з минулим міс.</span>
                    </div>
                </div>

                <div class="card p-6 border-l-4 border-rose-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-stone-500 text-sm font-medium">Витрати (місяць)</p>
                            <h3 class="text-2xl font-bold text-stone-800 mt-1">${formatter.format(currentExpense)} ₴</h3>
                        </div>
                        <div class="bg-rose-100 p-2 rounded-lg text-rose-600">
                            <i class="fa-solid fa-money-bill-transfer"></i>
                        </div>
                    </div>
                    <div class="mt-4 text-sm flex items-center gap-2">
                        ${formatChange(expenseChange, true)} 
                        <span class="text-stone-500 text-xs"> порівняно з минулим міс.</span>
                    </div>
                </div>

                <div class="card p-6 border-l-4 border-amber-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-stone-500 text-sm font-medium">Баланс (місяць)</p>
                            <h3 class="text-2xl font-bold text-stone-800 mt-1">${formatter.format(currentBalance)} ₴</h3>
                        </div>
                        <div class="bg-amber-100 p-2 rounded-lg text-amber-600">
                            <i class="fa-solid fa-piggy-bank"></i>
                        </div>
                    </div>
                    <div class="mt-4 text-sm flex items-center gap-2">
                        ${formatChange(balanceChange, false)}
                        <span class="text-stone-500 text-xs"> порівняно з минулим міс.</span>
                    </div>
                </div>
            `;
        }
        
        function getChartData() {
            // This function calculates data for the daily Bar Chart
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            const monthlyTransactions = state.transactions.filter(t => {
                const date = new Date(t.date);
                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            });
            
            // This is primarily for daily analysis
            const dailyData = monthlyTransactions.reduce((map, t) => {
                const day = t.date;
                map[day] = map[day] || { income: 0, expense: 0 };
                if (t.type === 'income') {
                    map[day].income += t.amount;
                } else {
                    map[day].expense += t.amount;
                }
                return map;
            }, {});

            const barLabels = Object.keys(dailyData).sort();
            const incomeSeries = barLabels.map(day => dailyData[day].income);
            const expenseSeries = barLabels.map(day => dailyData[day].expense);

            return { barLabels, incomeSeries, expenseSeries };
        }
        
        function getMonthlyExpenseData() {
            // This function calculates data for the 6-month Line Chart
            const monthlyData = {};
            const monthNames = ['Січ', 'Лют', 'Бер', 'Квіт', 'Трав', 'Черв', 'Лип', 'Серп', 'Вер', 'Жовт', 'Лист', 'Груд'];

            // 1. Calculate expenses per month
            state.transactions
                .filter(t => t.type === 'expense')
                .forEach(t => {
                    const date = new Date(t.date);
                    const yearMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    monthlyData[yearMonth] = (monthlyData[yearMonth] || 0) + t.amount;
                });
            
            // 2. Generate labels and data for the last 6 months
            const labels = [];
            const series = [];
            const today = new Date();

            for (let i = 5; i >= 0; i--) {
                const monthDate = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const year = monthDate.getFullYear();
                const month = monthDate.getMonth();
                const monthName = monthNames[month];
                
                const key = `${year}-${String(month + 1).padStart(2, '0')}`;
                
                labels.push(`${monthName} ${year % 100}`); // e.g., "Жовт 25"
                series.push(monthlyData[key] || 0);
            }

            return { labels, series };
        }


        function initCharts() {
            const barCtx = document.getElementById('barChart').getContext('2d');
            const lineCtx = document.getElementById('lineChart').getContext('2d'); // <-- NEW CONTEXT
            
            barChartInstance = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: [], 
                    datasets: [
                        {
                            label: 'Дохід',
                            data: [], 
                            backgroundColor: 'rgba(16, 185, 129, 0.8)', 
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Витрата',
                            data: [], 
                            backgroundColor: 'rgba(244, 63, 94, 0.8)', 
                            borderColor: 'rgba(244, 63, 94, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // NEW LINE CHART INITIALIZATION
            lineChartInstance = new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: [], 
                    datasets: [{
                        label: 'Витрати',
                        data: [], 
                        borderColor: '#F59E0B', // Amber color
                        backgroundColor: 'rgba(245, 158, 11, 0.2)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Сума (₴)'
                            }
                        },
                        x: {
                             grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function updateCharts() {
             // Check if both instances are initialized
             if (!barChartInstance || !lineChartInstance) { 
                initCharts();
                if (!barChartInstance || !lineChartInstance) return; 
            }

            const { barLabels, incomeSeries, expenseSeries } = getChartData();
            const monthlyData = getMonthlyExpenseData(); 
            
            // 1. Update Bar Chart (Daily)
            barChartInstance.data.labels = barLabels;
            barChartInstance.data.datasets[0].data = incomeSeries;
            barChartInstance.data.datasets[1].data = expenseSeries;
            barChartInstance.update();
            
            // 2. Update Line Chart (Monthly)
            lineChartInstance.data.labels = monthlyData.labels;
            lineChartInstance.data.datasets[0].data = monthlyData.series;
            lineChartInstance.update();
        }
        
        // --- BUDGETING LOGIC ---

        function saveBudgets(e) {
            e.preventDefault();
            const container = document.getElementById('budgetFieldsContainer');
            state.budgets = {}; 

            container.querySelectorAll('input[type="number"]').forEach(input => {
                const category = input.name;
                const amount = parseFloat(input.value);

                if (!isNaN(amount) && amount > 0) {
                    state.budgets[category] = amount;
                }
            });
            
            alert('Бюджети успішно збережено!');
            renderBudgets();
            renderBudgetingAnalysis('budgetingAnalysisContentDashboard'); // Update Dashboard after save
            renderBudgetingAnalysis('budgetingAnalysisContentBudget');    // Update Budgeting view after save
        }
        
        function renderBudgets() {
            const container = document.getElementById('budgetFieldsContainer');
            container.innerHTML = '';
            
            const allExpenseCategories = CATEGORIES.expense.sort();

            allExpenseCategories.forEach(category => {
                const currentBudget = state.budgets[category] || '';
                
                const html = `
                    <div>
                        <label for="budget-${category}" class="form-label">${category} (Макс. ₴)</label>
                        <input type="number" 
                               id="budget-${category}" 
                               name="${category}" 
                               value="${currentBudget}"
                               min="0"
                               step="0.01"
                               placeholder="Напр., 5000"
                               class="form-input">
                    </div>
                `;
                container.innerHTML += html;
            });
        }
        
        /**
         * Renders the budget analysis progress bars into the specified container.
         * @param {string} targetId - The ID of the HTML element where the analysis should be rendered.
         */
        function renderBudgetingAnalysis(targetId) {
            const analysisContainer = document.getElementById(targetId);
            if (!analysisContainer) return; 

            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            const monthlyExpenses = state.transactions.filter(t => {
                const date = new Date(t.date);
                return t.type === 'expense' && date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            });

            const categoryMap = monthlyExpenses.reduce((map, t) => {
                map[t.category] = (map[t.category] || 0) + t.amount;
                return map;
            }, {});
            
            let analysisHtml = '';
            const budgetedCategories = Object.keys(state.budgets).sort();
            
            if (budgetedCategories.length === 0) {
                 analysisHtml = `<p class="text-stone-500">Ви ще не налаштували жодного бюджету.</p>`;
            } else {
                
                analysisHtml = `<div class="space-y-4">`;
                
                budgetedCategories.forEach(category => {
                    const budgetAmount = state.budgets[category];
                    const amountSpent = categoryMap[category] || 0;
                    const remaining = budgetAmount - amountSpent;
                    const percentageSpent = (amountSpent / budgetAmount) * 100;
                    const isOverBudget = remaining < 0;
                    
                    const progressBarColor = isOverBudget ? 'bg-rose-500' : (percentageSpent > 80 ? 'bg-amber-500' : 'bg-emerald-500');

                    analysisHtml += `
                        <div class="p-4 border rounded-lg ${isOverBudget ? 'border-rose-300 bg-rose-50' : 'border-stone-200'}">
                            <div class="flex justify-between items-center text-md mb-1">
                                <span class="font-bold text-stone-800">${category}</span>
                                <span class="font-semibold ${isOverBudget ? 'text-rose-600' : 'text-stone-700'}">${formatter.format(amountSpent)} ₴ / ${formatter.format(budgetAmount)} ₴</span>
                            </div>
                            
                            <div class="w-full bg-stone-200 rounded-full h-3">
                                <div class="${progressBarColor} h-3 rounded-full" style="width: ${Math.min(100, percentageSpent)}%;"></div>
                            </div>
                            
                            <div class="flex justify-between text-sm mt-2">
                                ${isOverBudget ? 
                                    `<span class="text-rose-600 font-medium">Перевитрата: ${formatter.format(Math.abs(remaining))} ₴</span>` : 
                                    `<span class="text-emerald-600 font-medium">Залишок: ${formatter.format(remaining)} ₴</span>`
                                }
                                <span class="text-stone-500">${percentageSpent.toFixed(1)}% використано</span>
                            </div>
                        </div>
                    `;
                });
                analysisHtml += `</div>`;
            }
            
            analysisContainer.innerHTML = analysisHtml;
        }

        // --- AI Assistant Logic ---
        
        // Function to get aggregated data for the AI
        function getAggregatedData() {
            const { currentIncome, currentExpense, currentBalance, incomeChange, expenseChange, balanceChange } = calculateKpi();
            
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            const monthlyExpenses = state.transactions.filter(t => {
                const date = new Date(t.date);
                return t.type === 'expense' && date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            });
            
            const expenseByCategories = monthlyExpenses.reduce((map, t) => {
                map[t.category] = (map[t.category] || 0) + t.amount;
                return map;
            }, {});

            const sortedCategories = Object.entries(expenseByCategories).sort(([, a], [, b]) => b - a);
            const highestExpense = sortedCategories.length > 0 ? sortedCategories[0] : null;

            return {
                income: currentIncome,
                expense: currentExpense,
                balance: currentBalance,
                highestExpenseCategory: highestExpense ? highestExpense[0] : 'немає',
                highestExpenseAmount: highestExpense ? highestExpense[1] : 0,
                expenseChange: expenseChange,
                budgetData: state.budgets,
                categoryMap: expenseByCategories // Pass category map for detailed budget check
            };
        }

        // Mock AI function that generates advice based on data and query
        function getAIFinancialAdvice(query) {
            const data = getAggregatedData();
            const { income, expense, balance, highestExpenseCategory, highestExpenseAmount, expenseChange, budgetData, categoryMap } = data;
            const expensePercentage = income > 0 ? ((expense / income) * 100).toFixed(1) : '—';
            
            let advice = "";

            const lowQuery = query.toLowerCase();

            // 1. Порада за запитом про скорочення витрат / Highest Expense
            if (lowQuery.includes('скоротити') || lowQuery.includes('витрати') || lowQuery.includes('багато')) {
                if (highestExpenseAmount > 0) {
                    const budgetForHighest = budgetData[highestExpenseCategory] || 0;
                    
                    if (budgetForHighest > 0 && highestExpenseAmount > budgetForHighest) {
                         advice = `Ваша найбільша категорія витрат за поточний місяць — **${highestExpenseCategory}** (витрачено ${formatter.format(highestExpenseAmount)} ₴), і ви **перевищили** встановлений бюджет (${formatter.format(budgetForHighest)} ₴). Щоб скоротити витрати, негайно обмежте всі необов'язкові витрати у цій категорії.`;
                    } else {
                        advice = `Ваша найбільша категорія витрат за поточний місяць — **${highestExpenseCategory}** (витрачено ${formatter.format(highestExpenseAmount)} ₴). Спробуйте проаналізувати, чи можна знайти більш економні альтернативи, щоб зменшити витрати в цій сфері наступного місяця.`;
                    }
                } else {
                    advice = `За поточний місяць ми не бачимо значних витрат. Це чудово! Продовжуйте контролювати свої фінанси.`;
                }
            } 
            // 2. Порада про баланс
            else if (lowQuery.includes('баланс') || lowQuery.includes('загалом')) {
                if (balance > 0) {
                    advice = `Ваш поточний місячний баланс становить **+${formatter.format(balance)} ₴**. Це позитивний результат! Витрати складають лише ${expensePercentage}% від доходу. Рекомендуємо інвестувати залишок або поповнити резервний фонд.`;
                } else if (balance < 0) {
                    advice = `Ваш поточний баланс **-${formatter.format(Math.abs(balance))} ₴**. Вам варто переглянути свої витрати. Спробуйте обмежити витрати у категорії "${highestExpenseCategory}" до кінця місяця.`;
                } else {
                    advice = `Ваш дохід та витрати майже рівні. Поточний баланс: ${formatter.format(balance)} ₴.`;
                }
            } 
            // 3. Порада про динаміку
            else if (lowQuery.includes('динаміка') || lowQuery.includes('попереднім місяцем')) {
                const changeAbs = Math.abs(expenseChange).toFixed(1);
                if (expenseChange > 5) {
                    advice = `Увага! Ваші загальні витрати зросли на **+${changeAbs}%** порівняно з минулим місяцем. Це може бути пов'язано зі значними витратами у категорії **${highestExpenseCategory}**. Спробуйте перевірити цю тенденцію.`;
                } else if (expenseChange < -5) {
                    advice = `Чудова робота! Ви скоротили витрати на **${changeAbs}%** порівняно з минулим місяцем. Продовжуйте в тому ж дусі!`;
                } else {
                    advice = `Ваші фінанси стабільні. Витрати змінилися лише на ${changeAbs}% порівняно з попереднім місяцем.`;
                }
            }
            // 4. Порада про бюджетування
            else if (lowQuery.includes('бюджет') || lowQuery.includes('ліміт')) {
                const overspent = Object.entries(budgetData).find(([cat, budget]) => (categoryMap[cat] || 0) > budget);
                if (overspent) {
                    advice = `Ви перевищили бюджет у категорії **${overspent[0]}**. Витрачено ${formatter.format(categoryMap[overspent[0]])} ₴ при ліміті ${formatter.format(overspent[1])} ₴. Спробуйте перерозподілити кошти з інших категорій.`;
                } else if (Object.keys(budgetData).length > 0) {
                    const lowUsage = Object.entries(budgetData).find(([cat, budget]) => (categoryMap[cat] || 0) < budget * 0.5 && (categoryMap[cat] || 0) > 0);
                    if (lowUsage) {
                        advice = `Ваші бюджети під контролем. Особливо ефективно ви економите у категорії **${lowUsage[0]}**, де використано менше 50% бюджету.`;
                    } else {
                        advice = `Ваші бюджети під контролем. Ви ще не перевищили жодного ліміту цього місяця.`;
                    }
                } else {
                    advice = `У вас не встановлено жодного бюджету. Радимо налаштувати бюджети для основних категорій (Їжа, Оренда, Транспорт), щоб краще контролювати витрати.`;
                }
            }
            // 5. Загальна/невідома порада
            else {
                advice = `Дякую за запит. Ваша загальна фінансова ситуація: дохід ${formatter.format(income)} ₴, витрати ${formatter.format(expense)} ₴. Витрати складають ${expensePercentage}% від доходу. Спробуйте запитати про конкретніші речі, наприклад: "Як справи з бюджетами?" або "Яка моя динаміка?".`;
            }

            return advice;
        }

        // Handle form submission in AI Assistant view
        function submitAssistantQuery(e) {
            e.preventDefault();
            
            const queryInput = document.getElementById('assistantQuery');
            const chatWindow = document.getElementById('chatWindow');
            const userQuery = queryInput.value.trim();

            if (!userQuery) return;

            // 1. Додаємо запит користувача
            chatWindow.innerHTML += `
                <div class="user-message text-stone-700">
                    <p class="font-bold text-amber-800 mb-1"><i class="fa-solid fa-user mr-2"></i> Ви:</p>
                    <p>${userQuery}</p>
                </div>
            `;
            
            // Очищаємо поле вводу та фокусуємось
            queryInput.value = '';
            queryInput.disabled = true;
            document.getElementById('sendAssistantQuery').disabled = true;

            // 2. Імітація відповіді AI з затримкою
            setTimeout(() => {
                const advice = getAIFinancialAdvice(userQuery);

                chatWindow.innerHTML += `
                    <div class="assistant-message text-stone-700">
                        <p class="font-bold text-amber-600 mb-1"><i class="fa-solid fa-robot mr-2"></i> AI-Помічник:</p>
                        <p>${advice}</p>
                    </div>
                `;

                // Прокрутка до останнього повідомлення
                chatWindow.scrollTop = chatWindow.scrollHeight;
                
                // Вмикаємо поле вводу
                queryInput.disabled = false;
                document.getElementById('sendAssistantQuery').disabled = false;
                queryInput.focus();

            }, 1000); // Затримка 1 секунда для імітації обробки
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
            
            // Form listeners
            document.getElementById('addTransactionForm').addEventListener('submit', submitNewTransaction);
            document.getElementById('assistantForm').addEventListener('submit', submitAssistantQuery); 
            
            // Filter listeners
            document.getElementById('typeFilter').addEventListener('change', applyFilters);
            document.getElementById('categoryFilter').addEventListener('change', applyFilters);
            document.getElementById('searchFilter').addEventListener('input', applyFilters);
            
            // View switching listeners
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchView(e.currentTarget.dataset.view);
                });
            });

            populateCategorySelects();
            
            switchView('dashboard'); 

            initFirebase();
        });

    </script>
</body>
</html>
